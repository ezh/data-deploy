#!/usr/bin/bash
set -e

if [ "$(id -u)" != "0" ]; then
    echo "Run as root."
    exit 1
fi

KUBE_CLUSTER=http://localhost:8080
KBIN="kubectl -s $KUBE_CLUSTER"

is_running() {
    $KBIN get $1 > /dev/null 2>&1
    return $?
}

start_in_k8s() {
    name=$1
    for t in rc service pod; do
        full_name=$t/$name
        if is_running $full_name;
        then
            echo "$full_name is already running"
        else
            path=conf/$name-$t.yml
            if [[ -e $path ]]; then
                $KBIN create -f $path
                sleep 15
            fi
        fi
    done
}


if [[ -z $(docker-compose ps -q) ]]; then
    echo "Starting kubernetes cluster"
    docker-compose up -d
    sleep 30
else
    echo "Kubernetes cluster is already running"
fi
echo


if [ $($KBIN get rc --namespace=kube-system -l k8s-app=kube-ui |awk '{print $2}'|tail -1) = "kube-ui" ];
then
    echo "k8s UI already running"
else
    echo "Adding kube-ui addon"
    $KBIN create -f conf/kube-ui-rc.yml --namespace=kube-system
    $KBIN create -f conf/kube-ui-service.yml --namespace=kube-system
fi
echo


echo "Starting in Kubernetes"
for name in influxdb etcd rabbitmq; do
    start_in_k8s $name
done
echo


echo "Creating influxdb databases"
INFLUXDB_HOST=`$KBIN get service/influxdb -t={{.spec.clusterIP}}`
for name in data_stats monitoring; do
    curl -s -G http://$INFLUXDB_HOST:8086/query --data-urlencode "q=CREATE DATABASE $name" > /dev/null
done
echo


echo "Starting app"
for name in data-pipeline; do
    start_in_k8s $name
done
echo

echo "Done"
